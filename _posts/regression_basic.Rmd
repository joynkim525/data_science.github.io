---
title: "regression_basic"
output: html_document
---

<br><br><br>
가장 기본적인 데이터 cars를 활용하여 단순선형회귀분석을 이해해보자.<br>
(cars: 차량의 속도와 정지거리에 대한 데이터)<br>
<br>

<h4>우선 cars 데이터프레임의 구조를 확인하고 데이터의 분포, 요약 통계량을 확인해보자.</h4>

간단한 데이터에 대해서는 그다지 중요한 과정은 아님.<br>
하지만 컬럼 개수가 많아지고 복잡한 데이터의 경우 데이터 전처리에 대해 확인해야 하므로 습관적으로 하는 것이 좋음.<br>
(단위가 달라서 범위가 많이 차이나는 경우, 이상치 outlier가 있는 경우 등)<br>
<br>
```{r cars}
str(cars)
summary(cars)
hist(cars$speed)
hist(cars$dist)
```
<br><br>

<h4>회귀분석을 진행하는 데 앞서 회귀분석에는 다섯 가지의 가정사항이 있다.</h4>

1. y와 x는 선형적 관계에 있어야 한다 : 선형성 Linearity<br>
2. 오차항은 정규분포를 따른다 : 정규성 Normality<br>
3. 오차항의 평균 = 0 <br>
4. 오차항의 분산은 모두 같다 : 등분산성 Homoscedasticity<br>
5. 오차항은 서로 독립이다 : 독립성 Independence<br>

<br>

첫 번째 선형성 가정을 확인해보자.<br>
cor(cars)는 상관계수행렬(변수들 간 상관계수 값들로 이루어진 행렬)을 확인하는 코드로<br>
speed와 dist 사이의 선형적 상관관계는 0.8069 정도임을 알 수 있다.<br>
plot(cars)를 통해 산점도를 봤을 때도 나름 선형적인 상관관계가 높아보이는 것을 확인할 수 있다.<br>
변수가 많을 때는 corrplot을 그리는 것이 좋지만, 현재 경우에선 큰 의미 없음...ㅋㅋㅋ<br>
<br>
```{r}
cor(cars)
plot(cars)

library(corrplot)
corrplot(cor(cars))
```

<br><br>
오차항에 대한 가정은 데이터 상으로는 확인할 수 없기 때문에 지금은 넘어가고<br>

<h1>이제부터 단순회귀분석을 진행해보자</h1>

<br>
단순회귀분석 모델링을 할 때 우선 종속변수와 설명변수를 선정해야 한다.<br>
일반적으로 차량의 속도가 정지거리에 영향을 주는 관계에 있으므로<br>
dist를 종속변수로, speed를 설명변수로 설정한다.<br>
<br>

<h3>우리는 '차량의 속도가 빠를수록 정지거리가 길어진다.'라는 가설을 세우자.</h3>

$y = \beta_{0} + \beta_{1}x \quad where \quad \beta_{1} > 0$
라는 모델을 세우고  $\beta_{0}$와 $\beta_{1}$의 값을 추정해보자.<br><br>

```{r}
reg <- lm(dist ~ speed, cars)
summary(reg)
```
<br><br>
lm 함수는 회귀분석을 해주는 함수이고 **lm(y ~ x, data)** 형태로 입력해주면 된다.<br>
회귀분석을 한 결과를 확인하기 위해서는 summary() 안에 회귀분석 함수를 넣으면 된다.<br>
summary(lm(y ~ x, data))처럼 하면 되는데 일반적으로 plot까지 확인하기 위해서 reg라는 변수에 할당해준다.<br>
<br>

output에 대해 간단한 설명을 추가하자면,<br>
- Residuals: 이 부분은 적합된 회귀식(fitted regression line)과 실제 데이터 값 사이의 오차, 즉 잔차의 범위에 대한 정보<br><br>
- Coefficients: 이 부분은 적합된 회귀식(fitted regression line)에 대한 정보로,<br>
&nbsp;&nbsp;-> Estimate: 추정된 회귀계수<br>
&nbsp;&nbsp;-> Std. Error: 추정된 회귀계수에 대한 표준 오차 <br>
&nbsp;&nbsp;-> t value : cars 데이터로 계산한 회귀계수에 대한 t값<br>
&nbsp;&nbsp;-> Pr(>|t|) : t분포 검정통계량보다 t값이 더 큰 값이 나올 확률 = 귀무가설이 참일 때 귀무가설을 기각할 확률 <br>
&nbsp;&nbsp;(이하 **p-value**)<br><br>
- Residual standard error: 추정된 회귀식에 대한 표준 오차<br><br>
- Multiple R-squared: 추정된 회귀식으로 설명된 Y의 변동량의 비율<br><br>
- Adjusted R-squred: 변수 추가에 대한 penalty를 부과하여, 추정된 회귀식으로 설명된 Y의 변동량의 비율<br><br>
- F-statistic: cars 데이터로 계산한 회귀모델에 대한 F값<br>
<br>
<br>
dist를 종속변수로, speed를 설명변수로 한 회귀분석을 진행한 결과<br>
$dist = -17.5791 + 3.9324 * (speed)$ 회귀식을 얻을 수 있다.<br>
<br>

<h3>함수를 통해서 회귀식을 얻게 되면 첫 번째로 변수의 계수에 대한 유의성 검정을 진행한다.</h3>

회귀계수에 대한 유의성 검정의 귀무가설은 $\beta_{1} = 0$으로 설정한다.<br>
<br>
변수의 계수에 대한 유의성 검정은 t-검정을 이용하는데,<br>
Coefficients에 나온 t value와 p-vlaue를 활용하여 검정하면 된다.<br>
개별 회귀계수는 자유도가 'n - 1' (여기서 n은 데이터의 개수)인 t분포를 따르는데,<br>
t 검정통계량을 구하는 것은 t 분포표를 이용해야 하므로 일반적으로 p-value값을 사용한다.<br>
<br>
p-value는 귀무가설이 참일 때 귀무가설을 기각하는 통계량값이 나올 확률로, <br>
일반적으로 0.05보다 작을 경우 귀무가설을 기각한다.<br>
우리는 '회귀계수가 0이다'라는 귀무가설을 세웠으므로 회귀분석 결과를 보고 귀무가설 기각 여부를 결정하자.<br>
<br>
회귀분석의 목적은 설명변수의 유의미성이므로 y절편인 $\beta_{0}$에 대한 유의성 검정은 하지 않고 <br>
speed에 대한 유의성 검정만 진행하면, 회귀계수의 p-value는 1.49e-12이므로 일반적인 기준인 0.05보다 작다.<br>
따라서 귀무가설을 기각한다.<br>
즉, speed의 추정된 회귀계수는 0이 아니라고 할 수 있고, dist를 추정하는 데 유의한 변수라고 할 수 있다.<br>
<br><br>

<h3>다음으로는 회귀모델에 대한 유의성을 검정하자.</h3>

단순선형회귀모델에서는 변수가 하나밖에 없기 때문에 회귀계수가 유의하면 모델도 유의하다고 할 수 있지만,<br>
다중회귀분석의 경우에는 개별 변수의 유의성과 모델 전체의 유의성이 다를 수 있으므로 간략하게 소개하기로 한다.<br>
<br>
회귀모델에 대한 유의성 검정의 귀무가설을 $all \;\, \beta s =0$으로 설정한다.<br>
따라서 단순회귀분석에서는 회귀계수에 대한 귀무가설도, 회귀모델에 대한 귀무가설도 $\beta_{1} = 0$로 동일하게 된다.<br>
<br>
회귀모델에 대한 유의성 검정은 F-검정을 이용하는데,<br>
output 맨 마지막 줄에 나온 F-statistic과  p-value를 활용하여 검정하면 된다.<br>
회귀모델은 자유도가 'm, n-m-1'(여기서 n은 데이터의 개수, m은 변수의 개수)인 F분포를 따르는데,<br>
F 검정통계량을 구하는 것은 F분포표를 이용해야 하므로 일반적으로 p-value를 사용한다.<br>
<br>
위와 동일한 원리로 회귀모델의 p-value는 1.49e-12이므로 일반적인 기준인 0.05보다 작다.<br>
따라서 귀무가설을 기각한다.<br>
즉, speed를 이용하여 추정한 회귀모델은 유의하다고 할 수 있다.<br>
<br>

<h3>이제 그래프를 그려서 나머지 가정들을 확인해보도록 하자</h3>

회귀분석 결과를 plot으로 그려보면 4가지의 그래프가 나오게 된다.<br>
```{r}
par(mfrow = c(2,2))
plot(reg)
```
<br><br>
<h4>첫 번째 그래프는 적합된 값과 실제 값 사이의 오차인 잔차에 대한 그래프로,<br>
회귀분석의 세 번째 가정인 '오차항의 평균 = 0'와 네 번째 가정인 '오차항의 분산은 모두 같다'을 확인하는 데 사용된다.</h4>

빨간색 가이드라인이 0을 기준으로 직선 상태에 있는 것이 최고의 결과이지만,<br>
실제로 그런 결과가 나오기는 어려우므로 대략적으로 0을 중심으로 분포되어 있는지 확인하면 된다.<br>
그리고 잔차의 분포가 특정한 패턴(이차 곡선, 점차 분포가 넓어지거나 좁아짐 등)이 보이는지 확인하면 된다.<br><br>
여기서는 약간 기준선이 꺽여있기는 하지만 2차식으로 보기에는 무리가 있고,<br>
특별한 패턴 또한 보이지 않기 때문에 회귀분석 가정을 만족한다고 봐도 무방할 것 같다.<br>
<br><br>

<h4>두 번째 그래프는 이론적인 잔차값과 실제 잡차값(여기서는 표준화된 잔차값 이용) 사이의 그래프로,<br>
회귀분석의 두 번째 가정인 '오차항은 정규분포를 따른다'를 확인하는 데 사용된다.</h4>
대각선 점선이 이론적인 quantile값을 의미하며, 잔차들이 점선 위에 놓여있으면 정규성을 잘 따른다고 할 수 있다.<br>
여기서는 35, 23, 49번 데이터가 좀 벗어나 있는데, 이를 확인하기 위해 잔차의 히스토그램을 그려보자.<br>
```{r}
hist(reg$residuals)
```
<br><br>
히스토그램이 오른쪽 꼬리가 긴 모양이지만 중심극한정리에 따라 얼추 정규분포를 따른다고 하자.<br>
(중심극한정리: 데이터의 양이 충분히 커지면 모집단의 분포와 상관없이 표본평균의 분포는 근사적으로 정규분포를 따른다.)<br>
<br><br>

세 번째 그래프는 첫 번째 그래프와 동일한 정보를 가지고 있는 그래프로 봐도 무방하므로 넘어가도록 하자.<br>
궁금하신 분은 스스로 찾아보시기를 추천.<br>
<br><br>

<h4>네 번째 그래프는 각 데이터가 추정에 영향을 준 정도인 leverage에 대한 그래프로,<br>
Cook's distance를 이용하여 이상값을 확인하는 데 사용된다.</h4>

leverage는 해당 값으로 인해서 회귀식이 변화하는 정도로 볼 수 있고,<br> 
leverage가 큰 값은 회귀식 추정에 많은 영향을 주었다고 해서 영향점이라고도 부른다.<br>
그리고 Cook's distance는 잔차의 값과 leverage 값을 고려하여 계산한 거리인데,<br>
빨간색 점선으로 된 0.5 기준선을 넘어가거나 가까이 있으면 이상치(outlier)로 간주한다.<br><br>
여기서 49번 데이터를 이상치로 의심할 수 있다.<br>
하지만 데이터가 적기 때문에 두드러지는 것일 수 있으므로 여기서는 넘어가기로 한다.<br>
<br>
<br>
사실 그래프를을 해석하는 데 있어 주관이 개입될 여지가 많고 애매한 부분이 많아서<br>
가정을 확인하는 여러가지 검정들이 나왔는데, 정규성을 검정하는 Shapiro 검정과 독립성을 검정하는 Durbin-Watson 검정이 있다.<br>
등분산성 가정을 확인하는 검정은 없는 것 같아서 패스.<br>
<br>

<h3>Shapiro 검정을 이용해서 정규성을 검정해보자.</h3>

Shapiro 검정의 귀무가설은 '회귀모델이 정규분포를 따른다'이다.<br>
```{r}
shapiro.test(reg$residuals)
```
<br><br>
검정결과 p-value가 0.0215로 일반적인 기준인 0.05보다 작다.<br>
따라서 귀무가설을 기각한다.<br>
데이터의 양이 적기 때문일 수 있으므로 우선 독립성 검정을 해보고 모델을 수정할지 여부를 결정하자.<br>
<br>

<h3>그러면 이번에는 Durbin-Watson 검정을 이용해서 독립성을 검정해보자.</h3>

Durbin-Watson 검정은 자기상관 지수를 나타낸다.<br>
설명변수의 개수에 따라 판단 범위가 다른데,<br>
설명변수가 한 개인 경우 1.5083 이상 1.585 이하인 값이 나오면 잔차가 자기상관이 있다고 할 수 있다.<br>
```{r}
library(car)
durbinWatsonTest(reg$residuals)
```
<br><br>
여기서는 잔차가 자기상관이 없다고 나온다.<br>
따라서 데이터의 양이 커짐에 따라 근사적으로 정규분포를 따를 것이라고 보고,<br>
현재 회귀모형은 적합하다고 볼 수 있을 것 같다.<br>
<br>

<h3>회귀모형에 대한 가정까지 확인이 끝났다면, 회귀분석 결과를 해석해보자.</h3>
```{r}
summary(reg)
```
cars 데이터로 추정한 $dist = -17.5791 + 3.9324 * (speed)$ 회귀식을 해석해보면,<br>
speed가 1 (측정)단위만큼 증가할 때 dist가 3.9324 (측정)단위만큼 증가한다.<br>
즉, 차량의 속도가 1mph 빨라질수록 정지거리는 3.9324ft 증가한다.<br>
따라서 우리가 처음에 가정했던 '차량의 속도가 빠를수록 정지거리가 길어진다.'라는 가설이 참임을 확인할 수 있다.<br>
<br><br>
이렇게 회귀분석 기초가 끝났습니다^^<br>
위에서 이상치로 예상되었던 49번 데이터를 삭제한 회귀분석 모델링을 진행하고<br>
위의 흐름대로 가정에 대한 확인을 해서 삭제 전후 결과를 비교해보면 이해하기 좋을 것 같아요!<br><br><br>